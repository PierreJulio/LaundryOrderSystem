<div class="grid">
    <p-toast></p-toast>

    <div class="col-12">
        <p-card>
            <ng-template pTemplate="header">
                <div class="flex justify-content-between align-items-center p-3">
                    <h2 class="m-0">Validation des Commandes</h2>
                    <button pButton icon="pi pi-refresh" label="Actualiser" (click)="loadPendingOrders()"></button>
                </div>
            </ng-template>

            <p-table [value]="pendingOrders" [paginator]="true" [rows]="10" 
                    [rowsPerPageOptions]="[5,10,25]" [loading]="loading"
                    styleClass="p-datatable-sm" [responsive]="true">
                <ng-template pTemplate="header">
                    <tr>
                        <th>#</th>
                        <th>Date</th>
                        <th>Client</th>
                        <th>Articles</th>
                        <th>Actions</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-order>
                    <tr>
                        <td>{{ order.id }}</td>
                        <td>{{ order.orderDate | date:'dd/MM/yyyy' }}</td>
                        <td>{{ order.userName }}</td>
                        <td>{{ (order.items?.length || 0) }} article(s)</td>
                        <td>
                            <button pButton icon="pi pi-check-circle" label="Valider" 
                                    class="p-button-success mr-2"
                                    (click)="showValidationDialog(order)"></button>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="5" class="text-center p-4">
                            Aucune commande en attente de validation
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </p-card>
    </div>

    <!-- Dialogue de validation -->
    <p-dialog header="Valider la commande" [(visible)]="validationVisible" 
              [modal]="true" [style]="{width: '500px'}" [draggable]="false" [resizable]="false">
        <div *ngIf="selectedOrder" class="grid p-fluid">
            <div class="col-12">
                <h4>Détails de la commande #{{ selectedOrder.id }}</h4>
                <p><strong>Client:</strong> {{ selectedOrder.userName }}</p>
                <p><strong>Date:</strong> {{ selectedOrder.orderDate | date:'dd/MM/yyyy' }}</p>
                <p><strong>Articles:</strong></p>
                <ul>                    <li *ngFor="let item of selectedOrder.items || []">
                        {{ item.name }} × {{ item.quantity || 1 }}
                    </li>
                </ul>
                
                <p *ngIf="selectedOrder.reason"><strong>Motif:</strong> {{ selectedOrder.reason }}</p>
                <p *ngIf="selectedOrder.comment"><strong>Commentaire:</strong> {{ selectedOrder.comment }}</p>
            </div>

            <div class="col-12">
                <form [formGroup]="validationForm" class="pt-3">
                    <div class="field">
                        <label for="status">Décision</label>
                        <p-dropdown id="status" [options]="statusOptions" formControlName="status"
                                   optionLabel="label" optionValue="value" styleClass="w-full"></p-dropdown>
                    </div>
                      <div class="field">
                        <label for="reason">Commentaire (facultatif)</label>
                        <textarea id="reason" pInputTextarea formControlName="reason" 
                                 rows="3" styleClass="w-full"></textarea>
                    </div>
                </form>
            </div>
        </div>
        <ng-template pTemplate="footer">
            <button pButton pRipple label="Annuler" icon="pi pi-times" class="p-button-text" 
                    (click)="validationVisible = false"></button>
            <button pButton pRipple label="Confirmer" icon="pi pi-check" 
                    (click)="validateOrder()"></button>
        </ng-template>
    </p-dialog>
</div>
